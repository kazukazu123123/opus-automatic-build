name: Build Opus (Windows via Ubuntu)

on:
  workflow_dispatch:

env:
  OPUS_VERSION: "1.6"
  DOWNLOAD_URL: "https://downloads.xiph.org/releases/opus/opus-${{ github.event.inputs.version }}.tar.gz"

permissions:
  contents: write
  actions: read

jobs:
  build:
    runs-on: ubuntu-24.04

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential autoconf libtool \
            gcc-mingw-w64-x86-64 g++-mingw-w64-x86-64 \
            gcc-mingw-w64-i686 g++-mingw-w64-i686 pkg-config zip wget

      - name: Download and Extract Opus
        run: |
          wget https://downloads.xiph.org/releases/opus/opus-${{ env.OPUS_VERSION }}.tar.gz
          tar -xzf opus-${{ env.OPUS_VERSION }}.tar.gz

      # ------------------------
      # Build for x86 (i686)
      # ------------------------
      - name: Build Opus for x86 (i686)
        run: |
          cd opus-${{ env.OPUS_VERSION }}
          ./configure --disable-intrinsics --host=i686-w64-mingw32 --disable-asm \
                      --prefix=/ --disable-rtcd --disable-extra-programs --disable-stack-protector \
                      --disable-static --enable-shared \
                      LDFLAGS="-static-libgcc"
          sed -i 's/-D_FORTIFY_SOURCE=2//g' Makefile
          make -j$(nproc)
          make install DESTDIR=$(pwd)/build/i686

      - name: Package x86 ZIP
        run: |
          cd opus-${{ env.OPUS_VERSION }}
          mkdir -p package_i686/bin package_i686/lib_x86 package_i686/include
          cp build/i686/bin/libopus-0.dll package_i686/bin/
          cp build/i686/lib/libopus.dll.a package_i686/lib_x86/
          cp -r build/i686/include/* package_i686/include/ || true
          
          ZIP_NAME="opus-windows-i686-${{ env.OPUS_VERSION }}.zip"
          cd package_i686 && zip -r ../../$ZIP_NAME .
          echo "I686_ARCHIVE=$ZIP_NAME" >> $GITHUB_ENV

      # ------------------------
      # Build for x64 (x86_64)
      # ------------------------
      - name: Build Opus for x64 (x86_64)
        run: |
          cd opus-${{ env.OPUS_VERSION }}
          make distclean
          ./configure --disable-intrinsics --host=x86_64-w64-mingw32 --disable-asm \
                      --prefix=/ --disable-rtcd --disable-extra-programs --disable-stack-protector \
                      --disable-static --enable-shared \
                      LDFLAGS="-static-libgcc"
          sed -i 's/-D_FORTIFY_SOURCE=2//g' Makefile
          make -j$(nproc)
          make install DESTDIR=$(pwd)/build/x86_64

      - name: Package x64 ZIP
        run: |
          cd opus-${{ env.OPUS_VERSION }}
          mkdir -p package_x86_64/bin package_x86_64/lib_x64 package_x86_64/include
          cp build/x86_64/bin/libopus-0.dll package_x86_64/bin/
          cp build/x86_64/lib/libopus.dll.a package_x86_64/lib_x64/
          cp -r build/x86_64/include/* package_x86_64/include/ || true

          ZIP_NAME="opus-windows-x86_64-${{ env.OPUS_VERSION }}.zip"
          cd package_x86_64 && zip -r ../../$ZIP_NAME .
          echo "X86_64_ARCHIVE=$ZIP_NAME" >> $GITHUB_ENV

      # ------------------------
      # GitHub Release
      # ------------------------
      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: "v${{ env.OPUS_VERSION }}"
          name: Opus ${{ env.OPUS_VERSION }} - Windows DLL Binaries
          body: |
            Windows DLL binaries for Opus ${{ env.OPUS_VERSION }}
            Built with MinGW-w64 on Ubuntu.
          files: |
            ${{ env.I686_ARCHIVE }}
            ${{ env.X86_64_ARCHIVE }}
          draft: false
          prerelease: false
          make_latest: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
